# Privilege Escalation

* [Windows Services](#Windows-Services)
* [UAC Bypasses](#UAC-Bypasses)

## Windows Services
Adversaries may create or modify Windows services to repeatedly execute malicious payloads as part of persistence and privlege escalation. 
### Unquoted Service Paths
An unquoted service path is where the path to the service binary is not wrapped in quotes. The vulnerabilty is how windows attempt to read thr path.

Condition:
* Has spaces in the path and also not quoted
* Permission to write in the file 

To list every services and the path to its executable WMI can be use:

```wmic service get name, pathname```

To check the permission:

```Powershell Get-Acl -Path “C:\Program Files\Vuln Services” | fl```
### Weak service Permission
The Vulnerability is to abuse weak permission by changing the binary path of service.
Use SharpUp to identify  service that are modifiable.

```
SharpUp.exe
```
Check what privileges has this service.

```
Powershell Get-ServiceAcl -Name nomService | select -expandproperty Access
```
```
sc  qc nom_service 
sc  config nom_service binpath="path\to\exploit" 
sc start nom_serrvice
```
### Weak Service Binary Permission
The Vulnerability is to abuse the privilege of the binary
```
Powershell Get-Acl -Path “pat/to/service” | fl
```
Upload the file and replace the service binary

### Always install elevated (TO Devlope)


## UAC Bypasses
An UAC bypass is a technique by which an application can go from Medium to High Integrity without prompting for consent. 
You need an administrator account.

Use tool like Seatbelt to check if it is possible

```
execute-assembly SharpUp.exe
```

Seabelt TokenPrivileges can list the current token’s privileges of a user.

```
execute-assembly Seabelt.exe TokenPrivileges

```
In cobalt Strick

```
elevate [exploit] [listener] 
runasadmin [exploit] [command + args] 
``` 
Use UACME Akagi: https://github.com/hfiref0x/UACME

```
akagi64 61 c:\windows\system32\cmd.exe

``` 




## privilege escalation:

ref : https://delinea.com/blog/windows-privilege-escalation


   - Vertical privilege escalation, sometimes referred to as privilege elevation, is when an attacker compromises a user account that has limited permissions on a system. They then look for ways to increase their privileges using the same account. For example, they might add the compromised account to the local administrator group.

   - Horizontal privilege escalation, the more common method, is when an attacker gains access to another credential on the network with higher privileges than the initial one used to gain their foothold. With higher-level privileges, an attacker can move freely around the network without detection.

### Insecure service permissions

This occurs when a service that's running under SYSTEM privileges, but the User has permissions to change the executable binpath to one which could create a reverse shell.

###  Unquoted service paths

Surprisingly, while this is a known technique used for many years, it’s still common to find many services with unquoted service paths. When combined with weak folder permissions, this allows an attacker to place an executable in a parent folder, where Windows will look for the executable first to execute. For example, you might have a service path as C:\Program Files\Vendor\binary.exe. When the path is unquoted and the User has permissions to place objects in the C:\Program Files\ path, Windows will first try to execute program.exe. If the attacker can place a binary called program.exe in the path, they can then elevate privileges to the account which that service is running.


###  Weak registry permissions

Like the insecure service permissions example, if an attacker can modify the registry configuration of a service, they can then change the path in service configuration to execute a binary they choose. This could create a reverse shell or elevate privileges on the system.

### Insecure service executables

If an attacker can simply replace the original executable with their own, they can then gain privilege escalation of the account which that service is running under.

### Passwords
passwords for privileged users sitting in a text file on a desktop, in a browser, or in a configuration file.

Searching the registry using the query: reg query HKLM /f password /t REG_SZ /s

Searching the file system within xml, ini and txt files for the string password: findstr /si password *.xml *.ini *.txt

### Overprivileged Users

https://www.youtube.com/watch?v=pOxXtSOo4e4

Uers may have Local Administrator rights on their personal workstations. Attackers can leverage these Local Administrator rights to escalate privileges up to Full Domain using tools such as mimikatz and changes in the OS configuration. 

### Security Account Manager (SAM)

Windows stores credentials within the Security Account Management (SAM) database in an encrypted form called a hash. This is a one-directional cryptographic algorithm, which means you need to know the original password to recreate the hash. The SAM and SYSTEM files are locked when Windows is running but an attacker might find a backup copy under the Windows repair directory.

Getting access to both the SYSTEM and SAM database could allow an attacker to extract the hashes. If the original password was a weak, reused password, it’s very likely the attacker can crack it. Here's an example of cracking a hash using Hashca

### Pass-the-hash

If an attacker can’t crack the password from the hash, they may still be able to move around the network using only the hash.

Environments where PtH may not work or may be more difficult to execute:

Environments that use multi-factor authentication (MFA) - In environments that use MFA, even if an attacker is able to obtain a user's password hash, they will still need to bypass the second factor of authentication, such as a smart card or token. This can make it more difficult to use the PtH technique effectively.

Environments that use Kerberos authentication - In environments that use Kerberos authentication, the password hash is not stored in a local database, but rather in the Kerberos ticket-granting ticket (TGT). This can make it more difficult for an attacker to obtain the password hash and use the PtH technique.

Environments with least privilege access control - In environments with least privilege access control, where users are only given the permissions they need to perform their job functions, it may be more difficult for an attacker to find a user with administrative privileges and obtain their password hash.

### OS vulnerabilities or kernel exploits

While these types of escalation attacks are less common, sometimes attackers will wait for months with access to a low privileged User, waiting for the moment a vulnerability is disclosed. A recent example known as Print Nightmare (CVE 2021 34527) is a vulnerability in the Print Spooler that enabled an attacker to perform remote code execution and privilege escalation. 

### DLL Hijacking :
A windows program looks for DLLs when it starts. If these DLL’s do not exist then it is possible to escalate privileges by placing a malicious DLL in the location where the application is looking for.



### Tools :

- PowerUp 
- Seatbelt
- winPEAS
- Windows-Exploit-Suggester

https://github.com/sagishahar/lpeworkshop

to learn about Process Injection and  Hijack Execution Flow 



https://delinea.com/blog/linux-privilege-escalation



